name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    container: rootproject/root:latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package manager
        run: |
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "apt-get not found in container; use an ubuntu/debian-based image or remove container usage" >&2
            exit 1
          fi

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.BUILD_TYPE }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build git python3-pip
          python3 -m pip install --break-system-packages pytest pytest-cov

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=ON \
            -DBUILD_BENCHMARKS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run C++ Tests
        run: ctest --test-dir build --output-on-failure --verbose

      - name: Run Python Tests
        run: pytest tests/ -v --tb=short

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/analyze
            build/benchmarks
          retention-days: 7

  sanitizers:
    name: Sanitizers (ASan/UBSan)
    runs-on: ubuntu-latest
    container: rootproject/root:latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package manager
        run: |
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "apt-get not found in container; use an ubuntu/debian-based image or remove container usage" >&2
            exit 1
          fi

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build clang

      - name: Configure with Sanitizers
        run: |
          CC=clang CXX=clang++ cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_SANITIZERS=ON \
            -DBUILD_TESTS=ON \
            -DBUILD_BENCHMARKS=OFF

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run Tests with Sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
          UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
        run: ctest --test-dir build --output-on-failure

  thread-sanitizer:
    name: Thread Sanitizer (TSan)
    runs-on: ubuntu-latest
    container: rootproject/root:latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package manager
        run: |
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "apt-get not found in container; use an ubuntu/debian-based image or remove container usage" >&2
            exit 1
          fi

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build clang libomp-dev

      - name: Configure with TSan
        run: |
          CC=clang CXX=clang++ cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_TSAN=ON \
            -DBUILD_TESTS=ON \
            -DBUILD_BENCHMARKS=OFF

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run Tests with TSan
        env:
          TSAN_OPTIONS: abort_on_error=1
        run: ctest --test-dir build --output-on-failure

  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest
    container: rootproject/root:latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package manager
        run: |
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "apt-get not found in container; use an ubuntu/debian-based image or remove container usage" >&2
            exit 1
          fi

      - name: Install clang-tidy (and Ninja + OpenMP headers)
        run: |
          apt-get update
          apt-get install -y cmake ninja-build clang clang-tidy libomp-dev

      - name: Configure
        run: |
          CC=clang CXX=clang++ cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        run: |
          find src -name '*.cpp' -print0 | \
          xargs -0 -r clang-tidy -p build --warnings-as-errors='*'

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    container: rootproject/root:latest
    if: github.ref == 'refs/heads/main'
    needs: build

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package manager
        run: |
          if ! command -v apt-get >/dev/null 2>&1; then
            echo "apt-get not found in container; use an ubuntu/debian-based image or remove container usage" >&2
            exit 1
          fi

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-benchmarks-${{ env.BUILD_TYPE }}
          restore-keys: |
            ${{ runner.os }}-pip-benchmarks-

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build python3-pip
          pip3 install --break-system-packages matplotlib

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_BENCHMARKS=ON

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Run Benchmarks
        run: |
          ./build/benchmarks \
            --benchmark_format=json \
            --benchmark_out=benchmark_results.json

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json
          retention-days: 30

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect mkdocs and docs changes
        id: detect_docs
        run: |
          CHANGED=false

          BEFORE='${{ github.event.before }}'
          AFTER='${{ github.sha }}'

          # Handle "first commit" edge case
          if [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            if git diff --name-only "$BEFORE..$AFTER" | grep -Eq '(^mkdocs.yml$|^docs/)' ; then
              CHANGED=true
            fi
          else
            # If no valid BEFORE, fall back to checking existence only
            if [ -f mkdocs.yml ] || [ -d docs ]; then
              CHANGED=true
            fi
          fi

          if [ -f mkdocs.yml ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        if: steps.detect_docs.outputs.present == 'true' && steps.detect_docs.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install mkdocs
        if: steps.detect_docs.outputs.present == 'true' && steps.detect_docs.outputs.changed == 'true'
        run: pip install mkdocs mkdocs-material

      - name: Build docs
        if: steps.detect_docs.outputs.present == 'true' && steps.detect_docs.outputs.changed == 'true'
        run: mkdocs build -d site

      - name: Upload docs artifact
        if: steps.detect_docs.outputs.present == 'true' && steps.detect_docs.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: site/
          retention-days: 7
